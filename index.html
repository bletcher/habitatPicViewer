<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fish Data Visualizations | SHEDS</title>

  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="libs/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="libs/landing-page/css/landing-page.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="libs/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="libs/leaflet/dist/leaflet.css" rel="stylesheet" type="text/css">

  <style>
    body, h1, h2, h3, h4, h5, h6 {
      font-weight: 400;
      font-family: "Open Sans", Helvetica, Arial, sans-serif !important;
    }

    .top-section {
      background: #222;
      color: white;
    }
    
    .funding-section img {
      margin: 10px 25px 10px 25px;
    }

    #mapwest {
      height: 300px;
      width: 450px;
      margin: 0 10px;
      display: block;
      margin: auto;
      width: 100%;
    }

    #mapstanley {
      height: 300px;
      width: 250px;
      margin: 0 10px;
      display: block;
      margin: auto;
      width: 85%;
    }

    div.tooltip {
      position: absolute;
      padding: 8px;
      font: 12px sans-serif;
      background: #C6C6C6;
      pointer-events: none;
      height: auto;
      width: 480px;
      text-align: center;
    }
    
    .object-fit_contain { object-fit: contain }
    
    img[class] { 
      width: 100%;
    }
    
    img2 {height:10%; width:10%; }
    
    imgTest {
      margin: 0;
      border: 2px solid white;
      -webkit-transition: opacity 500ms;
      transition: opacity 500ms;
    }
    
  </style>
</head>
<body>

  <div style="border-bottom: 2px solid #e7e7e7;background:#f8f8f8">
    <div class="container">
      <div class="row" style="margin-top: 20px; margin-bottom: 20px">
        <div class="col-xs-12">
          <h1>Habitat pictures viewer</h1>
        </div>
      </div>
    </div>
  </div>

  <div class="content-section-b top-section">
    <div class="container">
      <div class="row" style="margin-top: 20px; margin-bottom: 20px">

        <div class="col-md-8">

          <div class="col-md-6 text-center" style="margin-top: 10px">
            <h3>West Brook, MA</h3>
            <div>
              <div id="mapwest"></div>
            </div>
          </div>
          
          <div class="col-md-6 text-center" style="margin-top: 10px">
            <h3>Stanley Brook, ME</h3>
            <div>
              <div id="mapstanley"></div>
            </div>
          </div>
          
          <div class="row" >
            <div class="col-md-4 col-md-offset-4 text-center" style="margin-top: 30px">

   
                    <label for="selectedYearDD" class="col-xs-5">Year</label>
                    <div class="col-xs-7">

                      <select class="form-control" id="selectedYearDD">
                        <option selected="selected" value="2006">2006</option>
                        <option value="2007">2007</option>
                        <option value="2008">2008</option>
                        <option value="2009">2009</option>
                        <option value="2010">2010</option>
                        <option value="2011">2011</option>
                        <option value="2012">2012</option>
                      </select>
                    </div>
            

                  <div class="form-group">
                    <label for="selectedSeasonDD" class="col-xs-5">Season</label>
                    <div class="col-xs-7">
                      <select class="form-control" id="selectedSeasonDD">
                        <option selected="selected" value="1">Spring</option>
                        <option value="2">Summer</option>
                        <option value="3">Fall</option>
                        <option value="4">Winter</option>
                      </select>
                    </div>
                  </div>


            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
  


  <div class="content-section-b">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-12">

          <h2>Daily image test</h2>

          <div id="flickr-images"></div>
          <div id="grid"></div>

        </div>
      </div>
    </div>
  </div>


  <div class="content-section-b">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8">
          <h2>Project Team</h2>
          <p>Ben Letcher initiated the West Brook study in 1997 with Gabe Gries. Since then the study has been a collaboration among the <a href="http://www.lsc.usgs.gov/?q=cafb-population-dynamics-personnel" target="_blank">USGS Conte Laboratory</a> (Ben Letcher, Matt O'Donnell, Todd Dubreuil), the <a href="http://www.nrs.fs.fed.us/people/knislow" target="_blank">USFS Northern Research Station</a> (Keith Nislow, Jason Coombs), and the <a href="http://eco.umass.edu/" target="_blank">University of Massachusetts Department of Environmental Conservation</a> (<a href="http://www.cfc.umt.edu/personnel/details.php?ID=4461" target="_blank">Andrew Whiteley</a> - now at The University of Montana). </p>
           <p>Ben Letcher and Matt O'Donnell started the Stanley Brook study in 2006 with <a href="http://www.coopunits.org/Maine/People/Joseph_Zydlewski/" target="_blank">Joe Zydlewski </a> from <a href="https://umaine.edu/wle/faculty-staff-directory/" target="_blank">the University of Maine </a> and Bruce Connery of the <a href="https://www.nps.gov/acad/index.htm" target="_blank">National Park Service </a>.</p>
           <p>We thank the many graduate students, interns, post-docs and others who have helped sample the streams over the years. </p>
        </div>
      </div>
    </div>
  </div>


  <footer>
    <div class="container">
      <div class="row">
        <div class="col-xs-12">
          <p class="copyright text-muted">Copyright Â© 2016 SHEDS Development Team</p>
          <p class="copyright text-muted"><strong>Disclaimer:</strong> This web site (SHEDS) has not yet been approved by the U.S. Geological Survey (USGS). As such, it does not represent any official USGS finding or policy.</p>
        </div>
      </div>
    </div>
  </footer>



<script src="libs/leaflet/dist/leaflet.js"></script>
<script src="libs/d3/d3.min.js"></script>


<script src="/libs/jquery/dist/jquery.min.js"></script>
<script src="/libs/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/libs/intro.js/minified/intro.min.js"></script>


<script>

var app = {
  state:  {
    selectedWatershed: 'west',
    selectedYear: $("#selectedYearDD").val(),
    selectedSeason: $("#selectedSeasonDD").val()
  }
}

var riverNames = {
  'West Brook': 'WB',
  'WB Mitchell': 'OS',
  'WB Jimmy': 'OL',
  'WB Obear': 'IL',
  'east': 'east',
  'west': 'west',
  'mainstem': 'mainstem',
  'tidal': 'tidal',
};

var featureWest, featureStanley;

// update dropdown functions
$("#selectedYearDD").on("change", function () {
  console.log("#selectedYearDD change");
  app.state.selectedYear = $("#selectedYearDD").val();
  gridData();
  renderImages();
});
$("#selectedSeasonDD").on("change", function () {
  console.log("#selectedSeasonDD change");
  app.state.selectedSeason = $("#selectedSeasonDD").val();
  gridData();
  renderImages();
});

function imgError(image) {
    image.onerror = "";
    image.src = "/img/noImage.gif";
    console.log('in error');
    return true;
}


// read in data
d3.queue()
  .defer(d3.csv, 'data/coordsForD3JS.csv')
  .await(function (error, coords) {
    if (error) {
      alert('Error occurred while loading the data.');
      throw error;
    }

  app.locations = coords;
  console.log(app)

  app.locations.forEach(function (d) {
    d.lat = +d.lat;
    d.lon = +d.lon;
    d.river = riverNames[d.riverFull];
    d.LatLng = new L.LatLng(d.lat, d.lon)
  });

// map for West ///
  var latLonCenter = [42.434, -72.669],
      zoom = 15
      
  var locationsWest = app.locations.filter(function(d){return d.watershed == app.state.selectedWatershed})

  var mapWest = L.map('map' + app.state.selectedWatershed).setView(latLonCenter, zoom);

  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(mapWest);
  
  mapWest._initPathRoot();
  
  
  var year = 2006, season = 1;
  var locationsMap,featureWest;
  
  var svg = d3.select("#map" + app.state.selectedWatershed).select("svg"),
      g = svg.append("g");
  
  var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);
  
  
    var riverColors = d3.scaleOrdinal(d3.schemeCategory10)
      .domain(['WB', 'OS', 'OL', 'IL']);
  
    featureWest = g.selectAll("circle")
      .data(locationsWest)
      .enter().append("circle")
      .style("stroke", function(d) { return d3.rgb(riverColors(d.river)).darker(1); })
      .style("fill", function(d) { return riverColors(d.river); })
      .style("opacity", 0.6)
      .attr("r", 4)
      .on("mouseover", function(d) {
        d3.select(this)
          .attr("r", 8)
          .style("stroke", "red")
          .style("fill", "lightgrey");
        
        //var ext = new RegExp('jpg', 'i');
        var fileName = "img/" + d.river + "_" + app.state.selectedYear + "_" + app.state.selectedSeason + "_" + d.section + ".JPG";
        
        tooltip.html('<h3>River = ' + d.riverFull + ", Section = " + d.section + '</h3><br><img class="object-fit-contain" src= ' + 
                                                                                                                           fileName + 
                                                                                                                           ' onerror="imgError(this);"/' +  
                                                                                                                           '>')
           .style("right", "80px")// (d3.event.pageX + 15) + "px")
           .style("top",  "200px")// (d3.event.pageY - 15) + "px")
           .transition()
           .duration(100)
           .style("opacity", 1);
      })
      .on("mouseout", function (d) {
        d3.select(this)
          .attr("r", 4)
          .style("stroke", function(d) { return d3.rgb(riverColors(d.river)).darker(1); })
          .style("fill", function(d) { return riverColors(d.river); });
  
         tooltip.transition()
           .duration(250)
           .style("opacity", 0);
      });
      
  mapWest.on("viewreset", onViewResetWest)
  onViewResetWest();
  
  function onViewResetWest() {
    featureWest.attr("transform", function(d) {
      return "translate(" + mapWest.latLngToLayerPoint(d.LatLng).x + "," +
                            mapWest.latLngToLayerPoint(d.LatLng).y + ")";
    });
  }
  
  /////////////////////////////////////////////////////////////////////////////////////////////////////////////
  // repeat for Stanley, inefficient, but fast ////////////////////////////////////////////////////////////////
  /////////////////////////////////////////////////////////////////////////////////////////////////////////////
  app.state.selectedWatershed = 'stanley';
  latLonCenter = [44.303, -68.242]
  zoom = 14
      
  var locationsStanley = app.locations.filter(function(d){return d.watershed == app.state.selectedWatershed})

  var mapStanley = L.map('map' + app.state.selectedWatershed).setView(latLonCenter, zoom);

  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(mapStanley);
  
  mapStanley._initPathRoot();
  
  
  //var year = 2009, season = 1;
  var locationsMap,featureStanley;
  
  var svg = d3.select("#map" + app.state.selectedWatershed).select("svg"),
      g = svg.append("g");
  
    var riverColors = d3.scaleOrdinal(d3.schemeCategory10)
      .domain(['WB', 'OS', 'OL', 'IL']);
  
    featureStanley = g.selectAll("circle")
      .data(locationsStanley)
      .enter().append("circle")
      .style("stroke", function(d) { return d3.rgb(riverColors(d.river)).darker(1); })
      .style("fill", function(d) { return riverColors(d.river); })
      .style("opacity", 0.6)
      .attr("r", 4)
      .on("mouseover", function(d) {
        d3.select(this)
          .attr("r", 8)
          .style("stroke", "red")
          .style("fill", "lightgrey");

        var fileName = "img/" + d.river + "_" + app.state.selectedYear + "_" + app.state.selectedSeason + "_" + d.section + ".JPG";
        
        tooltip.html('<h3>River = ' + d.riverFull + ", Section = " + d.section + '</h3><br><img class="object-fit-contain" src= ' + 
                                                                                                                           fileName + 
                                                                                                                           ' onerror="imgError(this);"/' +  
                                                                                                                           '>')
           .style("right", "80px")// (d3.event.pageX + 15) + "px")
           .style("top",  "200px")// (d3.event.pageY - 15) + "px")
           .transition()
           .duration(100)
           .style("opacity", 1);
      })
      .on("mouseout", function (d) {
        d3.select(this)
          .attr("r", 4)
          .style("stroke", function(d) { return d3.rgb(riverColors(d.river)).darker(1); })
          .style("fill", function(d) { return riverColors(d.river); });
  
         tooltip.transition()
           .duration(250)
           .style("opacity", 0);
      });
      
  mapStanley.on("viewreset", onViewResetStanley)
  onViewResetStanley();
  
  function onViewResetStanley() {
    featureStanley.attr("transform", function(d) {
      return "translate(" + mapStanley.latLngToLayerPoint(d.LatLng).x + "," +
                            mapStanley.latLngToLayerPoint(d.LatLng).y + ")";
    });
  }  

});

///////////////////////////////////
// make a grid and fill with images

//https://bl.ocks.org/cagrimmett/07f8c8daea00946b9e704e3efcbd5739
function gridData() {
	var data = new Array();
	var xpos = 1; //starting xpos and ypos at 1 so the stroke will show when we make the grid below
	var ypos = 1;
	var width = 75;
	var height = 75;
	var numRows = 7;
	var numCols = 15;
	
	var imageRowMap = [
	  "WB",
	  "WB",
	  "WB",
	  "WB",
	  "OL",
	  "OS",
	  "IL"
	];
	
	var riverMult = [ 1,2,3,4,1,1,1 ];
	
	// iterate for rows	
	for (var row = 0; row < numRows; row++) {
		data.push( new Array() );
		
		// iterate for cells/columns inside rows
		for (var column = 0; column < numCols; column++) {
		  var columnPlus1 = (column + 1) * riverMult[row];
			data[row].push({
				x: xpos,
				y: ypos,
				width: width,
				height: height,
				imageName: "img/" + imageRowMap[row] + "_" + app.state.selectedYear + "_" + app.state.selectedSeason + "_" + columnPlus1 + ".JPG"
			})
			// increment the x position. I.e. move it over by 50 (width variable)
			xpos += width;
		}
		// reset the x position after a row is complete
		xpos = 1;
		// increment the y position for the next row. Move it down 50 (height variable)
		ypos += height;	
	}
	return data;
}

var gridDat = gridData();	
console.log(gridDat);

var grid = d3.select("#grid")
	.append("svg")
	.attr("width","1440px")
	.attr("height","510px");
	
var row = grid.selectAll(".row")
	.data(gridDat)
	.enter().append("g")
	.attr("class", "row");
	
var column = row.selectAll(".square")
	.data(function(d) { return d; })
	.enter().append("rect")
	.attr("class","square")
	.attr("x", function(d) { return d.x; })
	.attr("y", function(d) { return d.y; })
	.attr("width", function(d) { return d.width; })
	.attr("height", function(d) { return d.height; })
	.style("fill", "#fff")
	.style("stroke", "#222")
	.on('click', function(d) {

    });

renderImages();

function renderImages(){
  var image = row.selectAll(".image")
  	.data(function(d) { return d; });
  	
    image.enter().append("image")
  //	.attr("class","object-fit-contain")
   // .attr("class", "img")
  	.attr("xlink:href", function(d) { return d.imageName; } )
//  	.attr("onerror", imgError(this))
  	.attr("x", function(d) { return d.x; })
  	.attr("y", function(d) { return d.y; })
  	.attr("width", function(d) { return d.width; })
  	.attr("height", function(d) { return d.height; })
}	
	
//.attr("img", class="object-fit-contain" src = function(d) { return d.imageName; })
	
	
//	<img class="object-fit-contain" src= ' + fileName + ' onerror="imgError(this);"/' +  '>'
	
	



</script>

</body>
</html>

